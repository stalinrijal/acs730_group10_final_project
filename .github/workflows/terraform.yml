name: Terraform CI/CD

on:
    push:
          branches:
                  - main
                        paths:
                                - '**.tf'
                                    pull_request:
                                          branches:
                                                  - main

                                          env:
                                              TF_VERSION: 1.5.5
                                                  TF_WORKING_DIR: .

                                                  jobs:
                                                      terraform:
                                                            runs-on: ubuntu-latest
                                                                  defaults:
                                                                          run:
                                                                                    working-directory: ${{ env.TF_WORKING_DIR }}

                                                                                          steps:
                                                                                                - name: Checkout
                                                                                                        uses: actions/checkout@v3

                                                                                                              - name: Setup Terraform
                                                                                                                      uses: hashicorp/setup-terraform@v2
                                                                                                                              with:
                                                                                                                                        terraform_version: ${{ env.TF_VERSION }}

                                                                                                                                              - name: Validate Terraform
                                                                                                                                                      run: terraform validate

                                                                                                                                                            - name: Format Terraform
                                                                                                                                                                    run: terraform fmt -check

                                                                                                                                                                          - name: Terraform Plan
                                                                                                                                                                                  id: plan
                                                                                                                                                                                          run: terraform plan -no-color -out tfplan

                                                                                                                                                                                                - name: Apply Terraform
                                                                                                                                                                                                        if: github.ref == 'refs/heads/main'
                                                                                                                                                                                                                run: terraform apply -auto-approve tfplan

                                                                                                                                                                                                                      - name: Clean Up
                                                                                                                                                                                                                              run: |
                                                                                                                                                                                                                                        terraform workspace select default
                                                                                                                                                                                                                                                terraform workspace delete ${{ github.ref }}


